/*
 * jQuery Plugin: Tokenizing Autocomplete Text Entry
 * Version 1.4.2
 *
 * Copyright (c) 2009 James Smith (http://loopj.com)
 * Licensed jointly under the GPL and MIT licenses,
 * choose which one suits your project best!
 *
 */
(function(a){var b={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"Ã—",searchDelay:300,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:false,prePopulate:null,processPrePopulate:false,animateDropdown:true,onResult:null,onAdd:null,onDelete:null,allowCreation:false};var c={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"};var d={BEFORE:0,AFTER:1,END:2};var e={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188};a.fn.tokenInput=function(c,d){var e=a.extend({},b,d||{});return this.each(function(){new a.TokenList(this,c,e)})};a.TokenList=function(b,f,g){function O(b){var c=j.get(b);if(c){K(b,c)}else{if(g.url){var d={};d.data={};if(g.url.indexOf("?")>-1){var e=g.url.split("?");d.url=e[0];var f=e[1].split("&");a.each(f,function(a,b){var c=b.split("=");d.data[c[0]]=c[1]})}else{d.url=g.url}d.data[g.queryParam]=b;d.type=g.method;d.dataType=g.contentType;if(g.crossDomain){d.dataType="jsonp"}d.success=function(c){if(a.isFunction(g.onResult)){c=g.onResult.call(o,c)}if(g.allowCreation){c.push({name:m.val()+" (new)",id:m.val()})}j.add(b,g.jsonContainer?c[g.jsonContainer]:c);if(m.val().toLowerCase()===b){K(b,g.jsonContainer?c[g.jsonContainer]:c)}};a.ajax(d)}else if(g.local_data){var h=a.grep(g.local_data,function(a){return a.name.toLowerCase().indexOf(b.toLowerCase())>-1});if(a.isFunction(g.onResult)){h=g.onResult.call(o,h)}if(g.allowCreation){h.push({name:m.val()+" (new)",id:m.val()})}j.add(b,h);K(b,h)}}}function N(){var b=m.val().toLowerCase();if(b&&b.length){if(p){C(a(p),d.AFTER)}if(b.length>=g.minChars){H();clearTimeout(k);k=setTimeout(function(){O(b)},g.searchDelay)}else{F()}}}function M(a){a.removeClass(g.classes.selectedDropdownItem);r=null}function L(b){if(b){if(r){M(a(r))}b.addClass(g.classes.selectedDropdownItem);r=b.get(0)}}function K(b,c){if(c&&c.length){u.empty();var d=a("<ul>").appendTo(u).mouseover(function(b){L(a(b.target).closest("li"))}).mousedown(function(b){A(a(b.target).closest("li"));return false}).hide();a.each(c,function(c,e){var f=a("<li>"+J(e.name,b)+"</li>").appendTo(d);if(c%2){f.addClass(g.classes.dropdownItem)}else{f.addClass(g.classes.dropdownItem2)}if(c===0){L(f)}a.data(f.get(0),"tokeninput",{id:e.id,name:e.name})});G();if(g.animateDropdown){d.slideDown("fast")}else{d.show()}}else{if(g.noResultsText){u.html("<p>"+g.noResultsText+"</p>");G()}}}function J(a,b){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function I(){if(g.hintText){u.html("<p>"+g.hintText+"</p>");G()}}function H(){if(g.searchingText){u.html("<p>"+g.searchingText+"</p>");G()}}function G(){u.css({position:"absolute",top:a(s).offset().top+a(s).outerHeight(),left:a(s).offset().left,zindex:999}).show()}function F(){u.hide().empty();r=null}function E(b){var c=a.data(b.get(0),"tokeninput");var d=g.onDelete;var e=b.prevAll().length;if(e>q)e--;b.remove();p=null;m.focus();h=h.slice(0,e).concat(h.slice(e+1));if(e<q)q--;var f=a.map(h,function(a){return a.id});o.val(f.join(g.tokenDelimiter));i-=1;if(g.tokenLimit!==null){m.show().val("").focus()}if(a.isFunction(d)){d.call(o,c)}}function D(b){var c=p;if(p){C(a(p),d.END)}if(c===b.get(0)){C(b,d.END)}else{B(b)}}function C(a,b){a.removeClass(g.classes.selectedToken);p=null;if(b===d.BEFORE){t.insertBefore(a);q--}else if(b===d.AFTER){t.insertAfter(a);q++}else{t.appendTo(s);q=i}m.focus()}function B(a){a.addClass(g.classes.selectedToken);p=a.get(0);m.val("");F()}function A(b){var c=a.data(b.get(0),"tokeninput");var d=g.onAdd;if(i>0&&g.preventDuplicates){var e=null;s.children().each(function(){var b=a(this);var d=a.data(b.get(0),"tokeninput");if(d&&d.id===c.id){e=b;return false}});if(e){B(e);t.insertAfter(e);m.focus();return}}z(c.id,c.name);if(g.tokenLimit!==null&&i>=g.tokenLimit){m.hide();F();return}else{m.focus()}m.val("");F();if(a.isFunction(d)){d.call(o,c)}}function z(b,c){var d=a("<li><p>"+c+"</p></li>").addClass(g.classes.token).insertBefore(t);a("<span>"+g.deleteText+"</span>").addClass(g.classes.tokenDelete).appendTo(d).click(function(){E(a(this).parent());return false});var e={id:b,name:c};a.data(d.get(0),"tokeninput",e);h=h.slice(0,q).concat([e]).concat(h.slice(q));q++;var f=a.map(h,function(a){return a.id});o.val(f.join(g.tokenDelimiter));i+=1;return d}function y(a){return a>=48&&a<=90||a>=96&&a<=111||a>=186&&a<=192||a>=219&&a<=222}function x(){if(l===(l=m.val())){return}var a=l.replace(/&/g,"&").replace(/\s/g," ").replace(/</g,"<").replace(/>/g,">");v.html(a);m.width(v.width()+30)}if(typeof f==="string"){g.url=f;if(g.crossDomain===undefined){if(g.url.indexOf("://")===-1){g.crossDomain=false}else{g.crossDomain=location.href.split(/\/+/g)[1]!==g.url.split(/\/+/g)[1]}}}else if(typeof f==="object"){g.local_data=f}if(g.classes){g.classes=a.extend({},c,g.classes)}else if(g.theme){g.classes={};a.each(c,function(a,b){g.classes[a]=b+"-"+g.theme})}else{g.classes=c}var h=[];var i=0;var j=new a.TokenList.Cache;var k;var l;var m=a('<input type="text"  autocomplete="off">').css({outline:"none"}).focus(function(){if(g.tokenLimit===null||g.tokenLimit!==i){I()}}).blur(function(){F()}).bind("keyup keydown blur update",x).keydown(function(b){var c;var f;switch(b.keyCode){case e.LEFT:case e.RIGHT:case e.UP:case e.DOWN:if(!a(this).val()){c=t.prev();f=t.next();if(c.length&&c.get(0)===p||f.length&&f.get(0)===p){if(b.keyCode===e.LEFT||b.keyCode===e.UP){C(a(p),d.BEFORE)}else{C(a(p),d.AFTER)}}else if((b.keyCode===e.LEFT||b.keyCode===e.UP)&&c.length){B(a(c.get(0)))}else if((b.keyCode===e.RIGHT||b.keyCode===e.DOWN)&&f.length){B(a(f.get(0)))}}else{var g=null;if(b.keyCode===e.DOWN||b.keyCode===e.RIGHT){g=a(r).next()}else{g=a(r).prev()}if(g.length){L(g)}return false}break;case e.BACKSPACE:c=t.prev();if(!a(this).val().length){if(p){E(a(p))}else if(c.length){B(a(c.get(0)))}return false}else if(a(this).val().length===1){F()}else{setTimeout(function(){N()},5)}break;case e.TAB:case e.ENTER:case e.NUMPAD_ENTER:case e.COMMA:if(r){A(a(r));return false}break;case e.ESCAPE:F();return true;default:if(String.fromCharCode(b.which)){setTimeout(function(){N()},5)}break}});var n=a(b).val();var o=a(b).hide().val("").focus(function(){m.focus()}).blur(function(){m.blur()});var p=null;var q=0;var r=null;var s=a("<ul />").addClass(g.classes.tokenList).click(function(b){var c=a(b.target).closest("li");if(c&&c.get(0)&&a.data(c.get(0),"tokeninput")){D(c)}else{if(p){C(a(p),d.END)}m.focus()}}).mouseover(function(b){var c=a(b.target).closest("li");if(c&&p!==this){c.addClass(g.classes.highlightedToken)}}).mouseout(function(b){var c=a(b.target).closest("li");if(c&&p!==this){c.removeClass(g.classes.highlightedToken)}}).insertBefore(o);var t=a("<li />").addClass(g.classes.inputToken).appendTo(s).append(m);var u=a("<div>").addClass(g.classes.dropdown).appendTo("body").hide();var v=a("<tester/>").insertAfter(m).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:m.css("fontSize"),fontFamily:m.css("fontFamily"),fontWeight:m.css("fontWeight"),letterSpacing:m.css("letterSpacing"),whiteSpace:"nowrap"});o.val("");var w=g.prePopulate||o.data("pre");if(g.processPrePopulate&&a.isFunction(g.onResult)){w=g.onResult.call(o,w)}if(w&&w.length){a.each(w,function(a,b){z(b.id,b.name)})}if(n!=""){n=jQuery.parseJSON(n);a.each(n,function(b,c){c.name="";a.each(g.local_data,function(a,b){if(b.id==c.id){c.name=b.name;return}});if(c.name!=""){z(c.id,c.name)}})}};a.TokenList.Cache=function(b){var c=a.extend({max_size:500},b);var d={};var e=0;var f=function(){d={};e=0};this.add=function(a,b){if(e>c.max_size){f()}if(!d[a]){e+=1}d[a]=b};this.get=function(a){return d[a]}}})(jQuery)